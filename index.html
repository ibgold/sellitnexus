<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SELL IT | Client Delivery Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .sidebar-item.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950 p-6 hidden">
        <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-10">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-extrabold tracking-tighter text-slate-900 mb-2">SELL IT</h1>
                <p class="text-slate-500">Accédez à votre espace de livraison</p>
            </div>
            <form id="login-form">
                <div class="mb-6">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Token de connexion</label>
                    <input type="text" id="token-input" class="w-full px-5 py-4 rounded-2xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="votre-token" required>
                </div>
                <div id="login-error" class="hidden mb-4 text-sm text-red-500 font-semibold text-center"></div>
                <button type="submit" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 shadow-xl shadow-indigo-200">Se connecter</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-content" class="flex flex-col md:flex-row min-h-screen hidden">
        <aside class="w-full md:w-72 bg-white border-r border-slate-200 p-8 flex flex-col z-40">
            <div class="mb-12">
                <h1 class="text-3xl font-black tracking-tighter text-indigo-600">SELL IT</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Delivery Hub V1</p>
            </div>

            <nav class="flex-1 space-y-3" id="main-nav">
                <button onclick="switchTab('portfolio')" id="nav-portfolio" class="sidebar-item w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-sm font-bold text-slate-500 hover:bg-slate-50 hidden">
                    <i data-lucide="users" class="w-5 h-5"></i> Portfolio Clients
                </button>
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="sidebar-item w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-sm font-bold text-slate-500 hover:bg-slate-50">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
                </button>
                <button onclick="switchTab('onboarding')" id="nav-onboarding" class="sidebar-item w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-sm font-bold text-slate-500 hover:bg-slate-50">
                    <i data-lucide="file-check" class="w-5 h-5"></i> Onboarding
                </button>
                <button onclick="switchTab('actions')" id="nav-actions" class="sidebar-item w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-sm font-bold text-slate-500 hover:bg-slate-50">
                    <i data-lucide="check-square" class="w-5 h-5"></i> Plan d'Action
                </button>
                <button onclick="switchTab('performance')" id="nav-performance" class="sidebar-item w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-sm font-bold text-slate-500 hover:bg-slate-50">
                    <i data-lucide="trending-up" class="w-5 h-5"></i> Performance
                </button>
            </nav>

            <div class="pt-8 border-t border-slate-100">
                <button onclick="logout()" class="w-full flex items-center gap-4 px-5 py-3 text-sm font-bold text-red-500 hover:bg-red-50 rounded-2xl transition-all">
                    <i data-lucide="log-out" class="w-5 h-5"></i> Déconnexion
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto p-6 md:p-12">
            <div id="view-header"></div>
            <div id="tab-content" class="mt-8"></div>
        </main>
    </div>

    <script>
        const API_URL = ""; 
        let state = {
            token: localStorage.getItem('sellit_token') || null,
            user: null,
            clients: [], 
            currentClient: null, 
            activeTab: 'dashboard',
            allData: {} 
        };

        window.onload = async () => {
            if (state.token) await initApp();
            else showLogin();
        };

        async function initApp() {
            const data = await fetchInitialData(state.token);
            if (!data) return showLogin();

            state.user = data.user;
            state.clients = data.clients || [data.client]; 
            state.currentClient = data.client || state.clients[0];
            state.allData[state.currentClient.id] = data;

            if (state.user.role === 'admin') {
                document.getElementById('nav-portfolio').classList.remove('hidden');
                state.activeTab = 'portfolio';
            }

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            render();
        }

        async function fetchInitialData(token) {
            if (!API_URL) return getMockData(token); 
            try {
                const res = await fetch(`${API_URL}?token=${token}`);
                return await res.json();
            } catch (e) { return null; }
        }

        function switchTab(tabId) {
            state.activeTab = tabId;
            render();
        }

        function selectClient(clientId) {
            state.currentClient = state.clients.find(c => c.id === clientId);
            state.activeTab = 'dashboard';
            render();
        }

        function render() {
            const header = document.getElementById('view-header');
            const content = document.getElementById('tab-content');
            
            if (state.activeTab === 'portfolio') {
                header.innerHTML = `
                    <h2 class="text-4xl font-extrabold text-slate-900 tracking-tight">Master Dashboard</h2>
                    <p class="text-slate-500 mt-1">Suivi global de vos cabinets</p>
                `;
            } else {
                const progress = (state.currentClient.current_phase / 4) * 100;
                const phases = ["Cadrage", "Analyse", "Organisation", "Performance"];
                header.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-8">
                        <div>
                            <h2 class="text-4xl font-extrabold text-slate-900 tracking-tight">Cabinet ${state.currentClient.name}</h2>
                            <p class="text-slate-500 mt-1">Interface de transparence SELL IT</p>
                        </div>
                        <div class="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm w-full md:w-80">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Audit Phase ${state.currentClient.current_phase}/4</span>
                                <span class="text-xs font-bold text-indigo-600">${Math.round(progress)}%</span>
                            </div>
                            <div class="w-full bg-slate-100 h-2.5 rounded-full overflow-hidden">
                                <div class="bg-indigo-600 h-full" style="width: ${progress}%"></div>
                            </div>
                            <p class="mt-3 text-sm font-bold text-slate-700">${phases[state.currentClient.current_phase-1]}</p>
                        </div>
                    </div>
                `;
            }

            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${state.activeTab}`).classList.add('active');

            if (state.activeTab === 'portfolio') renderPortfolio(content);
            else if (state.activeTab === 'dashboard') renderDashboard(content);
            else content.innerHTML = `<div class="p-20 text-center text-slate-400 font-bold uppercase tracking-widest text-sm">Vue ${state.activeTab} - Données en cours...</div>`;
            
            lucide.createIcons();
        }

        function renderPortfolio(container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${state.clients.map(client => `
                        <div onclick="selectClient('${client.id}')" class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm hover:border-indigo-500 transition-all cursor-pointer group">
                            <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center group-hover:bg-indigo-50 group-hover:text-indigo-600 transition-colors mb-6">
                                <i data-lucide="building"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-900 mb-1">${client.name}</h3>
                            <p class="text-sm text-slate-400 mb-6">Mise à jour : ${client.last_audit_date || 'N/A'}</p>
                            
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] font-black text-slate-400 uppercase">Progression</span>
                                <span class="text-[10px] font-black text-indigo-600 uppercase">Phase ${client.current_phase}/4</span>
                            </div>
                            <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden mb-6">
                                <div class="bg-indigo-600 h-full" style="width: ${(client.current_phase/4)*100}%"></div>
                            </div>
                            
                            <div class="flex items-center justify-between text-[10px] font-black text-slate-500 uppercase tracking-tighter pt-4 border-t border-slate-50">
                                <span>Accéder au Hub</span>
                                <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderDashboard(container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 text-center md:text-left">Statut Général</p>
                        <p class="text-4xl font-black text-indigo-600 text-center md:text-left">Audit Actif</p>
                    </div>
                    <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 text-center md:text-left">Prochaine Étape</p>
                        <p class="text-4xl font-black text-slate-800 text-center md:text-left">Analyse</p>
                    </div>
                    <div class="bg-indigo-600 p-8 rounded-3xl text-white shadow-xl shadow-indigo-100 flex flex-col justify-between items-center md:items-start">
                        <h3 class="font-black text-xl mb-2">Canal Support</h3>
                        <p class="text-indigo-100 text-xs mb-6 text-center md:text-left leading-relaxed">Besoin d'aide ? Votre consultant SELL IT est à votre écoute.</p>
                        <button class="w-full py-3 bg-white text-indigo-600 font-black rounded-xl text-sm hover:bg-slate-50 transition-colors">Lancer WhatsApp</button>
                    </div>
                </div>
            `;
        }

        function showLogin() { document.getElementById('login-screen').classList.remove('hidden'); }
        function logout() { localStorage.removeItem('sellit_token'); location.reload(); }

        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            const t = document.getElementById('token-input').value;
            localStorage.setItem('sellit_token', t);
            state.token = t;
            initApp();
        };

        function getMockData(t) {
            const isAdmin = t.includes('admin');
            return {
                user: { role: isAdmin ? 'admin' : 'user' },
                clients: isAdmin ? [
                    { id: 'c1', name: 'Dr. Martin', current_phase: 2, last_audit_date: '20 Déc' },
                    { id: 'c2', name: 'Clinique du Lac', current_phase: 1, last_audit_date: '15 Déc' },
                    { id: 'c3', name: 'Dr. Vassal', current_phase: 4, last_audit_date: '24 Déc' }
                ] : [],
                client: isAdmin ? null : { id: 'c1', name: 'Dr. Martin', current_phase: 2 }
            };
        }
    </script>
</body>
</html>
