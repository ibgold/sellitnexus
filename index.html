<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SELL IT | Client Delivery Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass-effect { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .sidebar-item.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <!-- LOGIN OVERLAY -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950 p-6 hidden">
        <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-10">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-extrabold tracking-tighter text-slate-900 mb-2">SELL IT</h1>
                <p class="text-slate-500">Accédez à votre espace de livraison</p>
            </div>
            <form id="login-form">
                <div class="mb-6">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Token Client Unique</label>
                    <input type="text" id="token-input" 
                        class="w-full px-5 py-4 rounded-2xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all"
                        placeholder="votre-token-securise" required>
                </div>
                <div id="login-error" class="hidden mb-4 text-sm text-red-500 font-semibold text-center"></div>
                <button type="submit" id="login-button"
                    class="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-200">
                    Se connecter
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN APP STRUCTURE -->
    <div id="app-content" class="flex flex-col md:flex-row min-h-screen hidden">
        
        <!-- SIDEBAR -->
        <aside class="w-full md:w-72 bg-white border-r border-slate-200 p-8 flex flex-col z-40">
            <div class="mb-12">
                <h1 class="text-3xl font-black tracking-tighter text-indigo-600">SELL IT</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Delivery Hub V1</p>
            </div>

            <nav class="flex-1 space-y-3" id="main-nav">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="sidebar-item w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-sm font-bold transition-all text-slate-500 hover:bg-slate-50">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
                </button>
                <button onclick="switchTab('onboarding')" id="nav-onboarding" class="sidebar-item w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-sm font-bold transition-all text-slate-500 hover:bg-slate-50">
                    <i data-lucide="file-check" class="w-5 h-5"></i> Onboarding
                </button>
                <button onclick="switchTab('actions')" id="nav-actions" class="sidebar-item w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-sm font-bold transition-all text-slate-500 hover:bg-slate-50">
                    <i data-lucide="check-square" class="w-5 h-5"></i> Plan d'Action
                </button>
                <button onclick="switchTab('performance')" id="nav-performance" class="sidebar-item w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-sm font-bold transition-all text-slate-500 hover:bg-slate-50">
                    <i data-lucide="trending-up" class="w-5 h-5"></i> Performance
                </button>
            </nav>

            <div class="pt-8 border-t border-slate-100 space-y-4">
                <div id="internal-toggle-container" class="hidden">
                    <button onclick="toggleInternalView()" class="w-full flex items-center justify-center gap-3 px-4 py-3 text-xs font-bold text-indigo-600 bg-indigo-50 rounded-xl hover:bg-indigo-100 transition-colors uppercase tracking-tight">
                        <i data-lucide="shield" class="w-4 h-4"></i> <span id="view-mode-text">Mode Admin</span>
                    </button>
                </div>
                <button onclick="logout()" class="w-full flex items-center gap-4 px-5 py-3 text-sm font-bold text-red-500 hover:bg-red-50 rounded-2xl transition-all">
                    <i data-lucide="log-out" class="w-5 h-5"></i> Quitter
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 overflow-y-auto p-6 md:p-12">
            <header class="flex flex-col md:flex-row md:items-center justify-between gap-8 mb-12">
                <div>
                    <h2 id="client-name" class="text-4xl font-extrabold text-slate-900 tracking-tight">Cabinet Chargement...</h2>
                    <p class="text-slate-500 mt-1">Interface de transparence SELL IT</p>
                </div>
                <div class="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm w-full md:w-80">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Progression de l'Audit</span>
                        <span id="audit-percent" class="text-xs font-bold text-indigo-600">0%</span>
                    </div>
                    <div class="w-full bg-slate-100 h-2.5 rounded-full overflow-hidden">
                        <div id="progress-bar" class="bg-indigo-600 h-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <p id="current-phase-text" class="mt-3 text-sm font-bold text-slate-700">Phase : ...</p>
                </div>
            </header>

            <div id="tab-content" class="transition-all duration-300">
                <!-- Contenu injecté ici par JS -->
            </div>
        </main>
    </div>

    <!-- LOADING SPINNER -->
    <div id="loading-overlay" class="fixed inset-0 z-[60] flex items-center justify-center bg-white/80 hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent"></div>
    </div>

    <script>
        // CONFIGURATION
        const API_URL = ""; // Remplacez par l'URL de votre Google Apps Script après déploiement

        // STATE
        let state = {
            token: localStorage.getItem('sellit_token') || null,
            data: null,
            activeTab: 'dashboard',
            isInternalMode: false
        };

        // INITIALIZATION
        window.onload = () => {
            if (state.token) {
                initApp();
            } else {
                showLogin();
            }
            lucide.createIcons();
        };

        // AUTH FUNCTIONS
        async function initApp() {
            const success = await fetchData(state.token);
            if (success) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                if (state.data.user.role === 'admin') {
                    document.getElementById('internal-toggle-container').classList.remove('hidden');
                }
                render();
            } else {
                showLogin();
            }
        }

        async function fetchData(token) {
            if (!API_URL) {
                console.error("API_URL non configurée");
                // Mock data pour la démo si pas d'API
                state.data = getMockData();
                return true;
            }
            showLoading(true);
            try {
                const response = await fetch(`${API_URL}?token=${token}`);
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                state.data = result;
                return true;
            } catch (err) {
                console.error(err);
                return false;
            } finally {
                showLoading(false);
            }
        }

        function showLogin() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-content').classList.add('hidden');
        }

        function logout() {
            localStorage.removeItem('sellit_token');
            location.reload();
        }

        // NAVIGATION
        function switchTab(tabId) {
            state.activeTab = tabId;
            render();
        }

        function toggleInternalView() {
            state.isInternalMode = !state.isInternalMode;
            render();
        }

        // RENDER FUNCTIONS
        function render() {
            const data = state.data;
            if (!data) return;

            // Update Header
            document.getElementById('client-name').innerText = `Cabinet ${data.client.name}`;
            const phases = ["Cadrage", "Analyse", "Organisation", "Performance"];
            const phaseIdx = data.client.current_phase - 1;
            document.getElementById('current-phase-text').innerText = `Phase : ${phases[phaseIdx]}`;
            const progress = (data.client.current_phase / 4) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('audit-percent').innerText = `${Math.round(progress)}%`;

            // Update Nav UI
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${state.activeTab}`).classList.add('active');
            
            // Update Admin Button
            if (data.user.role === 'admin') {
                document.getElementById('view-mode-text').innerText = state.isInternalMode ? "Mode Consultant" : "Voir Mode Client";
            }

            // Render Content
            const content = document.getElementById('tab-content');
            content.innerHTML = '';

            switch(state.activeTab) {
                case 'dashboard': renderDashboard(content); break;
                case 'onboarding': renderOnboarding(content); break;
                case 'actions': renderActions(content); break;
                case 'performance': renderPerformance(content); break;
            }

            lucide.createIcons();
        }

        function renderDashboard(container) {
            const docsDone = state.data.docs.filter(d => d.status === 'Reçu').length;
            const tasksDone = state.data.tasks.filter(t => t.status === 'Fait').length;

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Docs Reçus</p>
                        <p class="text-4xl font-black text-blue-600">${docsDone}/${state.data.docs.length}</p>
                    </div>
                    <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Tâches Finies</p>
                        <p class="text-4xl font-black text-green-600">${tasksDone}</p>
                    </div>
                    <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Santé Projet</p>
                        <p class="text-4xl font-black text-indigo-600">Stable</p>
                    </div>

                    <div class="md:col-span-2 bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                        <h3 class="text-xl font-extrabold mb-6 flex items-center gap-3">
                            <i data-lucide="clock" class="text-indigo-600"></i> Dernières Actions
                        </h3>
                        <div class="space-y-6">
                            ${state.data.tasks.slice(0, 3).map(task => `
                                <div class="flex items-center gap-5 group cursor-default">
                                    <div class="w-3 h-3 rounded-full ${task.status === 'Fait' ? 'bg-green-500' : 'bg-amber-500'} ring-4 ring-slate-50"></div>
                                    <div class="flex-1">
                                        <p class="font-bold text-slate-800 text-sm">${task.label}</p>
                                        <p class="text-xs text-slate-400 uppercase font-bold tracking-tighter">${task.status}</p>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300 group-hover:text-indigo-600 transition-colors"></i>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-indigo-600 p-8 rounded-3xl text-white shadow-2xl shadow-indigo-200 flex flex-col justify-between">
                        <div>
                            <h3 class="font-black text-xl mb-4">Besoin d'aide ?</h3>
                            <p class="text-indigo-100 text-sm leading-relaxed">Votre consultant est disponible via votre canal WhatsApp sécurisé.</p>
                        </div>
                        <button class="mt-8 w-full py-4 bg-white text-indigo-600 font-black rounded-2xl hover:bg-slate-50 transition-all flex items-center justify-center gap-3">
                            Ouvrir WhatsApp <i data-lucide="external-link" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderOnboarding(container) {
            container.innerHTML = `
                <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="p-8 border-b border-slate-100 flex items-center justify-between">
                        <div>
                            <h3 class="text-2xl font-black">Checklist Onboarding</h3>
                            <p class="text-slate-500 text-sm">Transmettez les documents pour débloquer l'analyse</p>
                        </div>
                        <i data-lucide="file-check" class="w-8 h-8 text-indigo-100"></i>
                    </div>
                    <div class="divide-y divide-slate-100">
                        ${state.data.docs.map(doc => `
                            <div class="p-8 flex flex-col md:flex-row md:items-center justify-between gap-6 hover:bg-slate-50 transition-colors">
                                <div class="flex gap-6">
                                    <div class="p-4 rounded-2xl ${doc.status === 'Reçu' ? 'bg-green-100 text-green-600' : 'bg-amber-100 text-amber-600'}">
                                        <i data-lucide="file" class="w-6 h-6"></i>
                                    </div>
                                    <div>
                                        <p class="text-lg font-bold text-slate-800">${doc.label}</p>
                                        <p class="text-sm font-medium ${doc.status === 'Reçu' ? 'text-green-500' : 'text-slate-400'}">${doc.status === 'Reçu' ? 'Document reçu et validé' : 'En attente de votre part'}</p>
                                    </div>
                                </div>
                                <div>
                                    ${doc.status === 'Attente' ? 
                                        `<button class="px-6 py-3 bg-indigo-600 text-white text-sm font-bold rounded-xl shadow-lg shadow-indigo-100">Soumettre</button>` : 
                                        `<a href="${doc.link}" target="_blank" class="flex items-center gap-2 text-indigo-600 font-bold hover:underline">Voir le fichier <i data-lucide="external-link" class="w-4 h-4"></i></a>`
                                    }
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderActions(container) {
            const filteredTasks = (state.isInternalMode || state.data.user.role !== 'admin') 
                ? state.data.tasks 
                : state.data.tasks.filter(t => t.is_visible_client === "VRAI" || t.is_visible_client === true);

            container.innerHTML = `
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-2xl font-black">Plan d'Action Stratégique</h3>
                    ${state.isInternalMode ? `<button class="flex items-center gap-2 px-5 py-2.5 bg-slate-900 text-white rounded-xl text-sm font-bold"><i data-lucide="plus" class="w-4 h-4"></i> Nouvelle Tâche</button>` : ''}
                </div>
                <div class="grid grid-cols-1 gap-4">
                    ${filteredTasks.map(task => `
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex items-center justify-between">
                            <div class="flex items-center gap-5">
                                <div class="w-6 h-6 rounded-lg border-2 ${task.status === 'Fait' ? 'bg-indigo-600 border-indigo-600 text-white' : 'border-slate-200'} flex items-center justify-center">
                                    ${task.status === 'Fait' ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}
                                </div>
                                <div>
                                    <p class="font-bold ${task.status === 'Fait' ? 'text-slate-400 line-through' : 'text-slate-800'}">${task.label}</p>
                                    <div class="flex gap-2 mt-1">
                                        <span class="text-[10px] font-black uppercase px-2.5 py-1 bg-slate-100 text-slate-500 rounded-full">${task.category || 'Audit'}</span>
                                        ${state.isInternalMode && !task.is_visible_client ? '<span class="text-[10px] font-black uppercase px-2.5 py-1 bg-red-100 text-red-500 rounded-full">Privé Interne</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="hidden md:block">
                                <i data-lucide="user" class="w-5 h-5 text-slate-200"></i>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderPerformance(container) {
            const lastKpi = state.data.kpis[0] || { leads: 0, consults: 0, interventions: 0 };
            const rate = lastKpi.consults > 0 ? ((lastKpi.interventions / lastKpi.consults) * 100).toFixed(1) : 0;

            container.innerHTML = `
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-2xl font-black">Performance & Pipeline</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-10 rounded-3xl border border-slate-200 shadow-sm">
                        <h4 class="font-black text-slate-800 mb-10 text-lg uppercase tracking-widest">Entonnoir de Conversion</h4>
                        <div class="space-y-10">
                            ${renderBar("Leads reçus", lastKpi.leads, 200, "bg-blue-500")}
                            ${renderBar("Consultations", lastKpi.consults, lastKpi.leads || 1, "bg-indigo-500")}
                            ${renderBar("Interventions", lastKpi.interventions, lastKpi.consults || 1, "bg-green-500")}
                        </div>
                    </div>
                    <div class="bg-white p-10 rounded-3xl border border-slate-200 shadow-sm flex flex-col items-center justify-center text-center">
                        <div class="w-32 h-32 bg-green-50 text-green-600 rounded-full flex items-center justify-center mb-8 ring-8 ring-green-50/50">
                            <i data-lucide="trending-up" class="w-12 h-12"></i>
                        </div>
                        <h4 class="text-6xl font-black text-slate-900 mb-2">${rate}%</h4>
                        <p class="text-slate-500 font-bold uppercase tracking-widest text-xs">Taux de Closing Global</p>
                        <div class="mt-12 p-6 bg-slate-50 rounded-2xl border border-slate-100">
                            <p class="text-sm font-semibold text-slate-600 italic leading-relaxed">"Performances excellentes ce mois-ci, supérieures à la moyenne des cabinets de chirurgie esthétique."</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderBar(label, value, max, color) {
            const pct = Math.min((value / max) * 100, 100);
            return `
                <div>
                    <div class="flex justify-between items-end mb-3">
                        <span class="text-sm font-black text-slate-700 uppercase tracking-tighter">${label}</span>
                        <span class="text-xl font-black text-slate-900">${value}</span>
                    </div>
                    <div class="w-full bg-slate-100 h-4 rounded-full overflow-hidden">
                        <div class="${color} h-full transition-all duration-1000 ease-out shadow-inner" style="width: ${pct}%"></div>
                    </div>
                </div>
            `;
        }

        // HELPERS
        function showLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }

        function getMockData() {
            return {
                user: { role: 'admin', name: 'Dr. Test' },
                client: { name: 'Esthetique Pro', current_phase: 2 },
                docs: [
                    { id: 1, label: 'Accès Agenda', status: 'Reçu', link: '#' },
                    { id: 2, label: 'Scripts Actuels', status: 'Attente', link: '#' },
                    { id: 3, label: 'Exports CRM', status: 'Reçu', link: '#' }
                ],
                tasks: [
                    { id: 1, label: 'Audit des appels entrants', status: 'Fait', is_visible_client: true, category: 'Analyse' },
                    { id: 2, label: 'Réécriture script Closing', status: 'En cours', is_visible_client: true, category: 'Livrable' },
                    { id: 3, label: 'Vérification synchronisation Calendly', status: 'Attente', is_visible_client: false, category: 'Technique' }
                ],
                kpis: [{ leads: 154, consults: 42, interventions: 12 }]
            };
        }

        // FORM HANDLER
        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const token = document.getElementById('token-input').value;
            state.token = token;
            await initApp();
            if (!state.data) {
                document.getElementById('login-error').innerText = "Token invalide.";
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

    </script>
</body>
</html>
